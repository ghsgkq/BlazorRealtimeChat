<h3>Chat</h3>

@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.LocalStorage

@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@implements IAsyncDisposable

<div class="chat-container">
    <ul id="messagesList">
        @foreach (var message in _messages)
        {
            <li>@message</li>
        }
    </ul>
</div>

<div class="input-group">
    @* 사용자 이름 입력창은 서버(ChatHub)에서 토큰으로 직접 식별하므로 필요 없습니다. *@
    <input @bind="messageInput" placeholder="@($"{SelectedChannelName ?? "채널"}에 메시지 입력...")"
           @onkeyup="HandleEnterKey" disabled="@(!IsConnected)" />
    <button @onclick="Send" disabled="@(!IsConnected)">전송</button>
</div>

@code {
    // [수정] 부모 컴포넌트로부터 현재 선택된 채널 정보를 받습니다.
    [Parameter] public string? SelectedChannelId { get; set; }
    [Parameter] public string? SelectedChannelName { get; set; }

    private HubConnection? _hubConnection;
    private List<string> _messages = new List<string>();
    private string? messageInput;

    public bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        // GetItemAsync<string>을 권장합니다 (따옴표 문제 방지)
        var token = await LocalStorage.GetItemAsync<string>("authToken");

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"), options =>
            {
                options.AccessTokenProvider = () => Task.FromResult(token);
            })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string, string>("ReceiveMessage", (user, message) =>
        {
            var encodedMsg = $"{user}: {message}";
            _messages.Add(encodedMsg);
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chat 연결 실패: {ex.Message}");
        }
    }

    private async Task Send()
    {
        // [수정] SelectedChannelId가 있고 연결된 상태일 때만 전송합니다.
        if (IsConnected && !string.IsNullOrEmpty(messageInput) && !string.IsNullOrEmpty(SelectedChannelId))
        {
            try
            {
                // [수정] ChatHub.SendMessage(string channelId, string message) 규격에 맞춥니다.
                // 서버가 유저 이름을 직접 추출하므로 userInput은 보내지 않습니다.
                await _hubConnection!.SendAsync("SendMessage", SelectedChannelId, messageInput);
                messageInput = string.Empty;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"메시지 전송 오류: {ex.Message}");
            }
        }
    }

    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await Send();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null) await _hubConnection.DisposeAsync();
    }
}
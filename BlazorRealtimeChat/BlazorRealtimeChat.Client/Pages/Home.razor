@page "/"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

@using System.Security.Claims
@using System.Text.Json
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorRealtimeChat.Client.Layout
@using BlazorRealtimeChat.Client.Services
@using BlazorRealtimeChat.Shared.DTOs

@layout EmptyLayout
@implements IAsyncDisposable

@inject IAuthService AuthService
@inject IServiceProvider ServiceProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IServerService ServerService
@inject IChannelService ChannelService

<div class="d-flex home-container">
    <!-- 1. 서버 목록 사이드바 -->
    <div class="server-list-sidebar d-flex flex-column align-items-center p-2">
        @if (servers != null)
        {
            @foreach (var server in servers)
            {
                <div class="server-icon @(selectedServer == server ? "selected" : "")" @onclick="() => SelectServer(server)">
                    @server.ServerName.Substring(0, 1)
                </div>
            }
        }
        <div class="server-separator"></div>
        <div class="server-icon" @onclick="HandleCreateServer">+</div>
    </div>

    <!-- 2. 채널 목록 사이드바 -->
    <div class="channel-sidebar bg-dark text-light flex-shrink-0">
        @if (selectedServer != null)
        {
            <div class="p-3 border-bottom border-secondary">
                <h5 class="fw-bold mb-0">@selectedServer.ServerName</h5>
            </div>
            <div class="d-flex justify-content-between align-items-center p-3">
                <span class="small text-uppercase">채널</span>
                <button class="btn btn-sm text-light" @onclick="ToggleAddChannelInput">+</button>
            </div>

            <ul class="list-unstyled p-2">
                @if (showAddChannelInput)
                {
                    <li class="p-2">
                        <EditForm Model="newChannel" OnValidSubmit="HandleCreateChannel">
                            <DataAnnotationsValidator />
                            <div class="input-group">
                                <InputText @bind-Value="newChannel.ChannelName" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="새 채널 이름" />
                                <button type="submit" class="btn btn-sm btn-success">✓</button>
                            </div>
                            <ValidationMessage For="@(() => newChannel.ChannelName)" />
                        </EditForm>
                    </li>
                }

                @if (isLoadingChannels)
                {
                    <li class="p-2 text-muted">채널 목록을 불러오는 중...</li>
                }
                else if (channels != null && channels.Any())
                {
                    @foreach (var channel in channels)
                    {
                        <li class="channel-item p-2 rounded @(selectedChannel == channel ? "selected" : "")" @onclick="() => SelectChannel(channel)">
                            <span># @channel.ChannelName</span>
                        </li>
                    }
                }
                else
                {
                    <li class="p-2 text-muted">채널이 없습니다.</li>
                }
            </ul>
        }
        <div class="user-profile mt-auto p-3 d-flex align-items-center">
            <span class="bg-secondary rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">@currentUsername?.Substring(0,1).ToUpper()</span>
            <span class="fw-bold">@currentUsername</span>
        </div>
    </div>

    <!-- 3. 메인 콘텐츠 (채팅창) -->
    <div class="main-content d-flex flex-column flex-grow-1">
        <div class="chat-header p-3 border-bottom border-secondary">
            <h5 class="mb-0 fw-bold"># @(selectedChannel?.ChannelName ?? "채널을 선택하세요")</h5>
        </div>
        <div class="chat-messages flex-grow-1 p-3" style="overflow-y: auto;">
            @foreach (var message in chatMessages)
            {
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0"><span class="bg-secondary rounded-circle" style="width: 40px; height: 40px; display: block;"></span></div>
                    <div class="flex-grow-1 ms-3">
                        @((MarkupString)message)
                    </div>
                </div>
            }
        </div>
        <div class="chat-input p-3 bg-dark-subtle">
            <input type="text" class="form-control bg-dark text-light border-secondary" 
                   placeholder="@($"# {selectedChannel?.ChannelName ?? ""}에 메시지 보내기")" @bind="messageInput" @onkeyup="HandleChatInput" disabled="@(!isChatConnected)" />
        </div>
    </div>
</div>

@code {
    private List<ServerDto> servers;
    private ServerDto selectedServer;
    private ChannelDto selectedChannel;
    private List<ChannelDto> channels;
    private CreateChannelDto newChannel = new CreateChannelDto();
    private bool showAddChannelInput = false;
    private bool isLoadingChannels = false;

    // --- 채팅 관련 필드 ---
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    private HubConnection hubConnection;
    private List<string> chatMessages = new List<string>();
    private string messageInput;
    private string currentUsername;
    private bool isChatConnected => hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        currentUsername = authState.User.FindFirst("name")?.Value ?? "Anonymous";

        await InitializeSignalR();
        await LoadInitialServers();
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<string, string>("ReceiveMessage", (user, message) =>
        {
            var formattedMessage = $"<div class=\"fw-bold\">{user}</div><div>{message}</div>";
            chatMessages.Add(formattedMessage);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task LoadInitialServers()
    {
        try
        {
            servers = await ServerService.GetServersAsync();
            if (servers != null && servers.Any())
            {
                await SelectServer(servers.First());
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"서버 목록을 불러오는 데 실패했습니다: {ex.Message}");
        }
    }

    private async Task SelectServer(ServerDto server)
    {
        selectedServer = server;
        selectedChannel = null; // 다른 서버 선택 시, 현재 선택된 채널을 초기화합니다.
        isLoadingChannels = true;
        channels = null; 
        StateHasChanged();

        try
        {
            channels = await ChannelService.GetChannelsAsync(server.ServerId);
        }
        catch (Exception ex)
        { 
            Console.WriteLine($"{server.ServerName} 서버의 채널 목록을 불러오는 데 실패했습니다: {ex.Message}");
            channels = new List<ChannelDto>();
        }
        finally
        {
            isLoadingChannels = false;
        }

        // 서버를 선택하면 첫 번째 채널을 자동으로 선택
        if (channels != null && channels.Any())
        {
            await SelectChannel(channels.First());
        }
        else
        {
            // 채널이 없는 경우, UI를 한번 더 갱신하여 "채널을 선택하세요"가 표시되도록 합니다.
            StateHasChanged();
        }
    }

    private async Task SelectChannel(ChannelDto channel)
    {
        if (selectedChannel != null)
            await hubConnection.SendAsync("LeaveChannel", selectedChannel.ChannelId.ToString());

        selectedChannel = channel;
        chatMessages.Clear(); // 채널 변경 시 메시지 목록 초기화
        await hubConnection.SendAsync("JoinChannel", selectedChannel.ChannelId.ToString());
        StateHasChanged(); // 채널 선택이 UI에 반영되도록 상태 변경을 알립니다.
    }

    private async Task HandleCreateServer()
    {
        // SweetAlert2는 string이 아닌 JSON 객체를 반환하므로, JsonElement로 받습니다.
        var swalResult = await JSRuntime.InvokeAsync<JsonElement>("Swal.fire", new
        {
            title = "새 서버 만들기",
            text = "서버 이름을 입력하세요:",
            input = "text",
            showCancelButton = true,
            confirmButtonText = "만들기",
            cancelButtonText = "취소"
        });

        // 사용자가 '취소'를 누르지 않았고, 'value' 속성이 존재하는지 확인합니다.
        if (swalResult.TryGetProperty("value", out var valueElement) && valueElement.ValueKind == JsonValueKind.String)
        {
            string serverName = valueElement.GetString();

            if (string.IsNullOrWhiteSpace(serverName)) return;

            try
            {
                var newServerDto = new CreateServerDto { ServerName = serverName };
                var createdServer = await ServerService.CreateServerAsync(newServerDto);

                if (createdServer != null)
                {
                    servers.Add(createdServer);
                    await SelectServer(createdServer);
                    StateHasChanged();
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("Swal.fire", "오류", "서버를 만들지 못했습니다. API가 null을 반환했습니다.", "error");
                }
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("Swal.fire", "치명적 오류", $"서버 생성 중 예외가 발생했습니다: {ex.Message}", "error");
            }
        }
    }

    private void ToggleAddChannelInput()
    {
        showAddChannelInput = !showAddChannelInput;
    }

    private async Task HandleCreateChannel()
    {
        if (selectedServer == null) return;

        newChannel.ServerId = selectedServer.ServerId;
        var createdChannel = await ChannelService.CreateChannelAsync(newChannel);

        if (createdChannel != null)
        {
            channels.Add(createdChannel);
            newChannel.ChannelName = string.Empty;
            showAddChannelInput = false;
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "오류", "채널 생성에 실패했습니다.", "error");
        }
    }

    private async Task HandleChatInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(messageInput))
        {
            if (selectedChannel != null && isChatConnected)
            {
                await hubConnection.SendAsync("SendMessageToChannel", selectedChannel.ChannelId.ToString(), currentUsername, messageInput);
                messageInput = string.Empty;
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

<style>
    .channel-item.selected {
        background-color: var(--bs-secondary); /* Bootstrap의 secondary 색상을 사용 */
    }
    .channel-item:hover {
        background-color: var(--bs-gray-700);
    }
</style>

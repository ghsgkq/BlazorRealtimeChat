@page "/register"
@layout EmptyLayout
@rendermode InteractiveWebAssembly

@using System.ComponentModel.DataAnnotations
@using BlazorRealtimeChat.Client.Layout
@using BlazorRealtimeChat.Shared.DTOs
@using BlazorRealtimeChat.Client.Services
@using Microsoft.AspNetCore.Authorization

@inject IServiceProvider ServiceProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="login-page-container">
    <div class="login-card-wrapper">
        <div class="login-card p-5 shadow">
            <div class="text-center mb-4">
                <h2 class="fw-bold">회원가입</h2>
                <p class="text-white">지금 계정을 만들고, 새로운 친구를 만나보세요!</p>
            </div>

            <EditForm Model="registerModel" OnValidSubmit="HandleRegistration">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label for="loginId" class="form-label text-uppercase small fw-bold text-white">아이디</label>
                    <InputText id="loginId" class="form-control form-control-lg bg-dark text-light border-secondary" @bind-Value="registerModel.LoginId" />
                    <ValidationMessage For="@(() => registerModel.LoginId)" />
                </div>

                <div class="mb-3">
                    <label for="username" class="form-label text-uppercase small fw-bold text-white">사용자 이름</label>
                    <InputText id="username" class="form-control form-control-lg bg-dark text-light border-secondary" @bind-Value="registerModel.Username" />
                    <ValidationMessage For="@(() => registerModel.Username)" />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label text-uppercase small fw-bold text-white">비밀번호</label>
                    <InputText id="password" type="password" class="form-control form-control-lg bg-dark text-light border-secondary" @bind-Value="registerModel.Password" />
                    <ValidationMessage For="@(() => registerModel.Password)" />
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label text-uppercase small fw-bold text-white">비밀번호 확인</label>
                    <InputText id="confirmPassword" type="password" class="form-control form-control-lg bg-dark text-light border-secondary" @bind-Value="registerModel.ConfirmPassword" />
                    <ValidationMessage For="@(() => registerModel.ConfirmPassword)" />
                </div>

                <button type="submit" class="btn btn-primary w-100 btn-lg mt-3" disabled="@isProcessing">
                    @if(isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <span>회원가입</span>
                    }
                </button>

                <div class="mt-3 text-center">
                    <span class="text-white small">이미 계정이 있나요? </span>
                    <a href="/login" class="small text-decoration-none">로그인</a>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private IRegisterService? registerService;
    private RegisterModel registerModel = new RegisterModel();
    private bool isProcessing = false;

    protected override void OnInitialized()
    {
        if (OperatingSystem.IsBrowser())
        {
            registerService = ServiceProvider.GetRequiredService<IRegisterService>();
        }
        
    }

    private async Task HandleRegistration()
    {
        if(registerService == null)
        {
            return;
        }

        isProcessing = true;
        var success = await registerService.RegisterAsync(
            registerModel.LoginId,registerModel.Username, registerModel.Password, registerModel.ConfirmPassword);
        
        if (success)
        {
            // Registration successful, redirect to login or home page
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            // Handle registration failure (e.g., show error message)
            // For simplicity, we just reset the processing state here
            await JSRuntime.InvokeVoidAsync("Swal.fire", "로그인 실패", "아이디와 비밀번호를 확인해주세요.", "error");

        }

        isProcessing = false;
    }

   
    public class RegisterModel
    {
        [Required(ErrorMessage = "사용자 이름을 입력하세요.")]
        [StringLength(50, ErrorMessage = "사용자 이름은 50자 이내여야 합니다.")]
        public string Username { get; set; }

        [Required(ErrorMessage = "아이디를 입력하세요.")]
        [StringLength(50, ErrorMessage = "아이디는 50자 이내여야 합니다.")]
        public string LoginId { get; set; }


        [Required(ErrorMessage = "비밀번호를 입력하세요.")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "비밀번호는 8자 이상이어야 합니다.")]
        public string Password { get; set; }

        [Required(ErrorMessage = "비밀번호를 다시 입력하세요.")]
        [Compare("Password", ErrorMessage = "비밀번호가 일치하지 않습니다.")] // <-- 핵심!
        public string ConfirmPassword { get; set; }
    }
  
}

@page "/invite/{ServerId:guid}"
@* 👇 1. WebAssembly 모드로 동작하도록 렌더링 모드를 지정합니다. *@
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using BlazorRealtimeChat.Client.Layout

@layout EmptyLayout

@using BlazorRealtimeChat.Client.Services
@using Microsoft.AspNetCore.Components.Authorization

@* 👇 2. [Authorize] 태그는 삭제했습니다. *@
@inject IServerService ServerService
@inject NavigationManager NavigationManager

<div class="d-flex vh-100 justify-content-center align-items-center bg-dark text-light">
    <div class="text-center p-5 rounded" style="background-color: #36393f; max-width: 400px; width: 100%;">
        @if (isProcessing)
        {
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <h4 class="fw-bold">서버로 이동 중입니다...</h4>
            <p class="text-white">잠시만 기다려 주세요.</p>
        }
        else if (isSuccess)
        {
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            <h4 class="fw-bold mt-3">참가 완료!</h4>
            <p class="text-white">채팅방으로 이동합니다.</p>
        }
        else
        {
            <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
            <h4 class="fw-bold mt-3">참가 실패</h4>
            <p class="text-white">서버를 찾을 수 없거나 이미 가입된 서버입니다.</p>
            <button class="btn btn-primary mt-3 w-100" @onclick='() => NavigationManager.NavigateTo("/")'>홈으로 돌아가기</button>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid ServerId { get; set; }

    // 👇 3. Home.razor처럼 로그인 상태를 가져오는 파라미터를 추가합니다.
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private bool isProcessing = true;
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        // 4. C# 로직 안에서 로그인 상태를 직접 검사합니다.
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity == null || !authState.User.Identity.IsAuthenticated)
            {
                // 로그인이 안 되어있다면, 로그인 페이지로 강제로 돌려보냅니다!
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }
        }

        // 5. 로그인된 유저라면 백엔드 API에 가입 처리를 요청합니다.
        try
        {
            isSuccess = await ServerService.JoinServerAsync(ServerId);
            isProcessing = false;
            StateHasChanged(); // 성공/실패 UI 렌더링

            if (isSuccess)
            {
                // 참가 성공 시 1.5초 뒤에 메인 화면(채팅방)으로 자연스럽게 이동시킵니다.
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/", forceLoad: true); 
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"초대 수락 에러: {ex.Message}");
            isProcessing = false;
            isSuccess = false;
            StateHasChanged();
        }
    }
}